{% extends 'base.html' %}
{% load static %}

{% block title %}DICOM Status - Internet Access{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="text-white mb-0">
                    <i class="fas fa-satellite-dish me-3"></i>DICOM Internet Access Status
                </h1>
                <div class="btn-group" role="group">
                    {% if is_admin %}
                    <a href="{% url 'admin_panel:facility_management' %}" class="btn btn-outline-light">
                        <i class="fas fa-hospital me-2"></i>Manage Facilities
                    </a>
                    {% endif %}
                    <button type="button" class="btn btn-medical" onclick="refreshStatus()">
                        <i class="fas fa-sync me-2"></i>Refresh Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card-medical p-3">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-success me-3">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div>
                        <h6 class="text-white mb-1">DICOM Port</h6>
                        <p class="text-secondary mb-0" id="dicom-port-status">
                            {% if dicom_status.port_accessible %}
                                <span class="text-success">✅ Accessible</span>
                            {% else %}
                                <span class="text-danger">❌ Not Accessible</span>
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card-medical p-3">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-info me-3">
                        <i class="fas fa-hospital"></i>
                    </div>
                    <div>
                        <h6 class="text-white mb-1">Active Facilities</h6>
                        <p class="text-secondary mb-0">{{ total_facilities }} facilities</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card-medical p-3">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-warning me-3">
                        <i class="fas fa-images"></i>
                    </div>
                    <div>
                        <h6 class="text-white mb-1">Studies Today</h6>
                        <p class="text-secondary mb-0">{{ total_studies_today }} studies</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card-medical p-3">
                <div class="d-flex align-items-center">
                    <div class="icon-circle bg-primary me-3">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <h6 class="text-white mb-1">Last Updated</h6>
                        <p class="text-secondary mb-0" id="last-updated">{{ dicom_status.test_time|date:"H:i:s" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Facility Configuration Section -->
    {% if user_facility %}
    <!-- Single Facility View (for facility users) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-medical p-4">
                <h5 class="text-white mb-3">
                    <i class="fas fa-hospital me-2"></i>{{ user_facility.name }} - DICOM Configuration
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="config-item mb-3">
                            <label class="text-secondary">Facility AE Title:</label>
                            <div class="text-white font-monospace fs-5">{{ user_facility.ae_title }}</div>
                        </div>
                        
                        <div class="config-item mb-3">
                            <label class="text-secondary">DICOM Machine Configuration:</label>
                            <div class="bg-dark p-3 rounded border">
                                <div class="text-white font-monospace">
                                    Called AE Title: <span class="text-info">NOCTIS_SCP</span><br>
                                    Calling AE Title: <span class="text-warning">{{ user_facility.ae_title }}</span><br>
                                    Hostname: <span class="text-success">{{ request.get_host }}</span><br>
                                    Port: <span class="text-info">11112</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="config-item mb-3">
                            <label class="text-secondary">Test Commands:</label>
                            <div class="bg-dark p-3 rounded border">
                                <div class="text-white font-monospace small">
                                    # Test connectivity:<br>
                                    <span class="text-info">telnet {{ request.get_host }} 11112</span><br><br>
                                    # Test DICOM echo:<br>
                                    <span class="text-info">echoscu -aet {{ user_facility.ae_title }} -aec NOCTIS_SCP {{ request.get_host }} 11112</span>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-medical" onclick="testFacilityConnection({{ user_facility.id }})">
                            <i class="fas fa-plug me-2"></i>Test Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Facilities Overview (for admins) -->
    {% if is_admin %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-medical p-4">
                <h5 class="text-white mb-3">
                    <i class="fas fa-list me-2"></i>Facility DICOM Configuration Overview
                </h5>
                
                {% if facility_stats %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Facility Name</th>
                                <th>AE Title</th>
                                <th>Status</th>
                                <th>Recent Studies (7d)</th>
                                <th>Total Studies</th>
                                <th>Last Activity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in facility_stats %}
                            <tr>
                                <td class="text-white">{{ stat.facility.name }}</td>
                                <td class="font-monospace text-warning">{{ stat.ae_title|default:"Not Set" }}</td>
                                <td>
                                    {% if stat.facility.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td class="text-info">{{ stat.recent_studies }}</td>
                                <td class="text-secondary">{{ stat.total_studies }}</td>
                                <td class="text-secondary">
                                    {% if stat.last_activity %}
                                        {{ stat.last_activity|timesince }} ago
                                    {% else %}
                                        Never
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="showDicomConfig({{ stat.facility.id }})" aria-label="Settings">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="testFacilityConnection({{ stat.facility.id }})" aria-label="Plug">
                                        <i class="fas fa-plug"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-hospital fa-3x text-secondary mb-3"></i>
                    <h6 class="text-white">No Facilities Found</h6>
                    <p class="text-secondary">Create your first facility to enable DICOM connectivity</p>
                    <a href="{% url 'admin_panel:facility_create' %}" class="btn btn-medical">
                        <i class="fas fa-plus me-2"></i>Create First Facility
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent DICOM Activity -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-medical p-4">
                <h5 class="text-white mb-3">
                    <i class="fas fa-activity me-2"></i>Recent DICOM Activity (24 hours)
                </h5>
                
                {% if recent_activity %}
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Facility</th>
                                <th>Patient ID</th>
                                <th>Study Description</th>
                                <th>Modality</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for study in recent_activity %}
                            <tr>
                                <td class="text-secondary">{{ study.upload_date|date:"M d, H:i" }}</td>
                                <td class="text-white">{{ study.facility.name }}</td>
                                <td class="font-monospace text-info">{{ study.patient.patient_id }}</td>
                                <td class="text-white">{{ study.description|truncatechars:50 }}</td>
                                <td class="text-warning">{{ study.modality.code }}</td>
                                <td><span class="badge bg-success">Received</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-secondary mb-3"></i>
                    <h6 class="text-white">No Recent Activity</h6>
                    <p class="text-secondary">No DICOM studies received in the last 24 hours</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- DICOM Configuration Instructions -->
    <div class="row">
        <div class="col-12">
            <div class="card-medical p-4">
                <h5 class="text-white mb-3">
                    <i class="fas fa-cogs me-2"></i>DICOM Machine Configuration Instructions
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-info mb-3">Step 1: Create Facility</h6>
                        <ol class="text-secondary">
                            <li>Access admin panel: <code>{{ request.get_host }}/admin/</code></li>
                            <li>Navigate to "Facility Management"</li>
                            <li>Click "Add Facility"</li>
                            <li>Fill in facility details</li>
                            <li>Note the auto-generated AE Title</li>
                            <li>Save the facility</li>
                        </ol>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-info mb-3">Step 2: Configure DICOM Machine</h6>
                        <div class="bg-dark p-3 rounded border">
                            <div class="text-white font-monospace">
                                <strong class="text-warning">Required Settings:</strong><br>
                                Called AE Title: <span class="text-info">NOCTIS_SCP</span><br>
                                Calling AE Title: <span class="text-warning">[Your Facility AE Title]</span><br>
                                Hostname: <span class="text-success">{{ request.get_host }}</span><br>
                                Port: <span class="text-info">11112</span><br>
                                Timeout: <span class="text-secondary">30 seconds</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Important:</strong> Each facility must use their unique AE Title as the "Calling AE Title" 
                            when configuring their DICOM machines. This ensures proper routing and security.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- DICOM Configuration Modal -->
<div  role="dialog" aria-modal="true" id="dicomConfigModal" tabindex="-1">
    <div  role="dialog" aria-modal="true">
        <div  role="dialog" aria-modal="true">
            <div  role="dialog" aria-modal="true">
                <h5 class="modal-title text-white">
                    <i class="fas fa-cog me-2"></i>DICOM Configuration
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div  role="dialog" aria-modal="true">
                <div id="dicom-config-content">
                    <!-- Content loaded via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Test Modal -->
<div  role="dialog" aria-modal="true" id="connectionTestModal" tabindex="-1">
    <div  role="dialog" aria-modal="true">
        <div  role="dialog" aria-modal="true">
            <div  role="dialog" aria-modal="true">
                <h5 class="modal-title text-white">
                    <i class="fas fa-plug me-2"></i>Connection Test
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div  role="dialog" aria-modal="true">
                <div id="connection-test-content">
                    <div class="text-center">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Testing...</span>
                        </div>
                        <p class="text-white mt-2">Testing DICOM connectivity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .icon-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .config-item label {
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .font-monospace {
        font-family: 'Courier New', monospace;
    }
    
    .table-dark {
        --bs-table-bg: transparent;
    }
    
    .table-dark td, .table-dark th {
        border-color: var(--border-color);
    }
    
    code {
        background: var(--card-surface);
        color: var(--accent-color);
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Refresh status
    function refreshStatus() {
        location.reload();
    }
    
    // Show DICOM configuration for facility
    function showDicomConfig(facilityId) {
        fetch(`/dicom/facility-config/${facilityId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const content = `
                    <div class="row">
                        <div class="col-12 mb-3">
                            <h6 class="text-info">Facility: ${data.facility_name}</h6>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-white">DICOM Machine Settings:</h6>
                            <div class="bg-secondary p-3 rounded">
                                <div class="text-white font-monospace">
                                    Called AE Title: <span class="text-info">${data.dicom_config.called_ae_title}</span><br>
                                    Calling AE Title: <span class="text-warning">${data.dicom_config.calling_ae_title}</span><br>
                                    Hostname: <span class="text-success">${data.dicom_config.hostname}</span><br>
                                    Port: <span class="text-info">${data.dicom_config.port}</span><br>
                                    Timeout: <span class="text-secondary">${data.dicom_config.timeout} seconds</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6 class="text-white">Test Commands:</h6>
                            <div class="bg-secondary p-3 rounded">
                                <div class="text-white font-monospace small">
                                    # Connectivity test:<br>
                                    <span class="text-info">${data.test_commands.telnet}</span><br><br>
                                    # DICOM echo test:<br>
                                    <span class="text-info">${data.test_commands.ping}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('dicom-config-content').innerHTML = content;
                new bootstrap.Modal(document.getElementById('dicomConfigModal')).show();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading DICOM configuration: ' + error.message);
            });
    }
    
    // Test facility connection
    function testFacilityConnection(facilityId) {
        const modal = new bootstrap.Modal(document.getElementById('connectionTestModal'));
        modal.show();
        
        // Reset content
        document.getElementById('connection-test-content').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Testing...</span>
                </div>
                <p class="text-white mt-2">Testing DICOM connectivity...</p>
            </div>
        `;
        
        // Perform test
        fetch('/dicom/test-connectivity/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `facility_id=${facilityId}`
        })
        .then(response => response.json())
        .then(data => {
            let content = '<div class="text-center">';
            
            if (data.port_accessible) {
                content += `
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h6 class="text-success">Connection Successful</h6>
                    <p class="text-white">DICOM port is accessible</p>
                `;
            } else {
                content += `
                    <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                    <h6 class="text-danger">Connection Failed</h6>
                    <p class="text-white">DICOM port is not accessible</p>
                `;
            }
            
            if (data.facility) {
                content += `
                    <div class="mt-3 text-start">
                        <h6 class="text-info">Facility Configuration:</h6>
                        <div class="bg-secondary p-2 rounded">
                            <div class="text-white font-monospace small">
                                Facility: ${data.facility.name}<br>
                                AE Title: ${data.facility.ae_title}<br>
                                Status: ${data.facility.status}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            content += '</div>';
            document.getElementById('connection-test-content').innerHTML = content;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('connection-test-content').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h6 class="text-warning">Test Error</h6>
                    <p class="text-white">Error testing connectivity: ${error.message}</p>
                </div>
            `;
        });
    }
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
    }, 30000);
</script>
{% endblock %}