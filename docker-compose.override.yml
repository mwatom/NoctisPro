version: '3.8'

# Development override - enables auto-reload and GitHub integration
services:
  web:
    volumes:
      - .:/app:cached  # Mount source code for live changes
    environment:
      - AUTO_RELOAD=true
    command: >
      sh -c "
        echo 'ğŸš€ Starting Noctis Pro Development Server...' &&
        echo 'ğŸ“¡ Web Interface: http://localhost:8000' &&
        echo 'ğŸ”§ Admin Panel: http://localhost:8000/admin-panel/' &&
        echo 'ğŸ“‹ Worklist: http://localhost:8000/worklist/' &&
        echo 'ğŸ¥ DICOM Port: localhost:11112' &&
        echo 'ğŸ’¾ Database: localhost:5432' &&
        echo 'ğŸ”„ Redis: localhost:6379' &&
        echo '' &&
        python manage.py migrate --noinput &&
        python manage.py collectstatic --noinput &&
        echo 'âœ… System ready! Access links above.' &&
        python manage.py runserver 0.0.0.0:8000
      "

  celery:
    volumes:
      - .:/app:cached
    environment:
      - AUTO_RELOAD=true

  dicom_receiver:
    volumes:
      - .:/app:cached
    environment:
      - AUTO_RELOAD=true

  # GitHub webhook receiver for auto-updates
  github_webhook:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: noctis_webhook
    environment:
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-github_webhook_secret}
    volumes:
      - .:/app:cached
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for container management
    ports:
      - "9000:9000"
    restart: unless-stopped
    command: python github_webhook_server.py
    depends_on:
      - web