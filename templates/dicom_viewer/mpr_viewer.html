<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPR Viewer - Noctis Pro PACS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Cornerstone Dependencies for Medical Imaging -->
    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
    <script src="https://unpkg.com/cornerstone-tools@6.0.10/dist/cornerstoneTools.min.js"></script>
    <script src="https://unpkg.com/cornerstone-web-image-loader@2.1.1/dist/cornerstoneWebImageLoader.min.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader@4.13.2/dist/cornerstoneWADOImageLoader.min.js"></script>
    <script src="https://unpkg.com/dicom-parser@1.8.21/dist/dicomParser.min.js"></script>
    <script src="https://unpkg.com/hammerjs@2.0.8/hammer.min.js"></script>
    
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --card-bg: #252525;
            --header-bg: #333333;
            --border-color: #404040;
            --accent-color: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #666666;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --danger-color: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            overflow: hidden;
            font-size: 12px;
        }

        .mpr-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Medical Grade Toolbar */
        .medical-toolbar {
            background: var(--header-bg);
            padding: 8px 12px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 12px;
            border-right: 1px solid var(--border-color);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-group label {
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        .medical-btn {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--secondary-bg) 100%);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-width: 80px;
            justify-content: center;
        }

        .medical-btn:hover {
            background: linear-gradient(135deg, var(--border-color) 0%, var(--card-bg) 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 212, 255, 0.2);
        }

        .medical-btn.active {
            background: linear-gradient(135deg, var(--accent-color) 0%, #0099cc 100%);
            color: var(--primary-bg);
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.4);
        }

        .back-btn {
            background: var(--danger-color);
            color: var(--text-primary);
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }

        .back-btn:hover {
            background: #cc3333;
            transform: translateY(-1px);
        }

        /* Professional 2x2 MPR Layout */
        .mpr-layout {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            background: var(--border-color);
            padding: 2px;
        }

        .mpr-viewport {
            background: #000000;
            position: relative;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .mpr-viewport.active {
            border: 2px solid var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .mpr-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        /* Medical Viewport Labels */
        .viewport-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--accent-color);
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .viewport-info {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.8);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 9px;
            font-family: 'Courier New', monospace;
            text-align: right;
        }

        /* Crosshair Styling */
        .crosshair {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }

        .crosshair-line {
            background: var(--accent-color);
            position: absolute;
            opacity: 0.8;
        }

        .crosshair-horizontal {
            height: 1px;
            width: 100%;
            top: 50%;
            left: 0;
        }

        .crosshair-vertical {
            width: 1px;
            height: 100%;
            left: 50%;
            top: 0;
        }

        /* Medical Controls */
        .controls-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            color: var(--text-primary);
            font-size: 10px;
            min-width: 200px;
        }

        .control-group {
            margin-bottom: 8px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-size: 9px;
        }

        .control-slider {
            width: 100%;
            height: 4px;
            background: var(--card-bg);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .control-slider::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            background: var(--accent-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .control-value {
            color: var(--accent-color);
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        /* 3D Reconstruction Panel */
        .reconstruction-panel {
            position: absolute;
            top: 60px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 10px;
            min-width: 180px;
        }

        .recon-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin: 2px;
            width: 100%;
            text-align: center;
        }

        .recon-btn:hover {
            background: var(--accent-color);
            color: var(--primary-bg);
        }

        .recon-btn.processing {
            background: var(--warning-color);
            color: var(--primary-bg);
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="mpr-container">
        <!-- Medical Grade Toolbar -->
        <div class="medical-toolbar">
            <button class="back-btn" onclick="window.location.href='/worklist/'">
                <i class="fas fa-arrow-left"></i> Worklist
            </button>
            
            <div class="toolbar-group">
                <label>Tools:</label>
                <button class="medical-btn active" id="wwwcTool" title="Window/Level">
                    <i class="fas fa-adjust"></i> W/L
                </button>
                <button class="medical-btn" id="zoomTool" title="Zoom">
                    <i class="fas fa-search-plus"></i> Zoom
                </button>
                <button class="medical-btn" id="panTool" title="Pan">
                    <i class="fas fa-hand-paper"></i> Pan
                </button>
            </div>
            
            <div class="toolbar-group">
                <label>Measure:</label>
                <button class="medical-btn" id="lengthTool" title="Length">
                    <i class="fas fa-ruler"></i> Length
                </button>
                <button class="medical-btn" id="angleTool" title="Angle">
                    <i class="fas fa-drafting-compass"></i> Angle
                </button>
                <button class="medical-btn" id="roiTool" title="ROI">
                    <i class="fas fa-square"></i> ROI
                </button>
            </div>
            
            <div class="toolbar-group">
                <label>View:</label>
                <button class="medical-btn" id="resetTool" title="Reset">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button class="medical-btn" id="invertTool" title="Invert">
                    <i class="fas fa-adjust"></i> Invert
                </button>
                <button class="medical-btn" id="syncTool" title="Sync Crosshairs">
                    <i class="fas fa-crosshairs"></i> Sync
                </button>
            </div>
        </div>

        <!-- Professional 2x2 MPR Layout -->
        <div class="mpr-layout">
            <!-- Axial View -->
            <div class="mpr-viewport active" id="axialViewport">
                <div class="viewport-label">Axial</div>
                <div class="viewport-info" id="axialInfo">
                    <div>Slice: 1/100</div>
                    <div>W: 400 L: 40</div>
                    <div>Zoom: 100%</div>
                </div>
                <div class="crosshair" id="axialCrosshair">
                    <div class="crosshair-line crosshair-horizontal"></div>
                    <div class="crosshair-line crosshair-vertical"></div>
                </div>
                <div class="mpr-canvas" id="axialCanvas"></div>
            </div>

            <!-- Sagittal View -->
            <div class="mpr-viewport" id="sagittalViewport">
                <div class="viewport-label">Sagittal</div>
                <div class="viewport-info" id="sagittalInfo">
                    <div>Slice: 1/100</div>
                    <div>W: 400 L: 40</div>
                    <div>Zoom: 100%</div>
                </div>
                <div class="crosshair" id="sagittalCrosshair">
                    <div class="crosshair-line crosshair-horizontal"></div>
                    <div class="crosshair-line crosshair-vertical"></div>
                </div>
                <div class="mpr-canvas" id="sagittalCanvas"></div>
            </div>

            <!-- Coronal View -->
            <div class="mpr-viewport" id="coronalViewport">
                <div class="viewport-label">Coronal</div>
                <div class="viewport-info" id="coronalInfo">
                    <div>Slice: 1/100</div>
                    <div>W: 400 L: 40</div>
                    <div>Zoom: 100%</div>
                </div>
                <div class="crosshair" id="coronalCrosshair">
                    <div class="crosshair-line crosshair-horizontal"></div>
                    <div class="crosshair-line crosshair-vertical"></div>
                </div>
                <div class="mpr-canvas" id="coronalCanvas"></div>
            </div>

            <!-- 3D/Volume View -->
            <div class="mpr-viewport" id="volumeViewport">
                <div class="viewport-label">3D Volume</div>
                <div class="viewport-info" id="volumeInfo">
                    <div>Rotation: 0°</div>
                    <div>Threshold: 200</div>
                    <div>Opacity: 80%</div>
                </div>
                <div class="mpr-canvas" id="volumeCanvas"></div>
            </div>
        </div>

        <!-- Medical Controls Panel -->
        <div class="controls-panel">
            <div class="control-group">
                <div class="control-label">Window Width</div>
                <input type="range" class="control-slider" id="windowWidth" min="1" max="4000" value="400">
                <span class="control-value" id="windowWidthValue">400</span>
            </div>
            <div class="control-group">
                <div class="control-label">Window Level</div>
                <input type="range" class="control-slider" id="windowLevel" min="-1000" max="3000" value="40">
                <span class="control-value" id="windowLevelValue">40</span>
            </div>
            <div class="control-group">
                <div class="control-label">Slice Position</div>
                <input type="range" class="control-slider" id="slicePosition" min="1" max="100" value="50">
                <span class="control-value" id="slicePositionValue">50/100</span>
            </div>
        </div>

        <!-- 3D Reconstruction Panel -->
        <div class="reconstruction-panel">
            <div class="control-label" style="margin-bottom: 8px;">3D Reconstruction</div>
            <button class="recon-btn" onclick="startBoneReconstruction()">
                <i class="fas fa-bone"></i> Bone 3D
            </button>
            <button class="recon-btn" onclick="startMRIReconstruction()">
                <i class="fas fa-brain"></i> MRI 3D
            </button>
            <button class="recon-btn" onclick="startMIPReconstruction()">
                <i class="fas fa-layer-group"></i> MIP
            </button>
            <button class="recon-btn" onclick="startVolumeRendering()">
                <i class="fas fa-cube"></i> Volume
            </button>
        </div>
    </div>

    <script>
        // Medical Grade MPR Viewer Implementation
        let viewports = {
            axial: null,
            sagittal: null,
            coronal: null,
            volume: null
        };
        
        let crosshairSync = true;
        let currentVolume = null;
        let volumeSpacing = [1, 1, 1];

        // Initialize Medical Grade MPR Viewer
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Initialize Cornerstone for medical imaging
                cornerstone.external.$ = window.jQuery || {};
                cornerstone.external.Hammer = Hammer;
                
                if (typeof cornerstoneTools !== 'undefined') {
                    cornerstoneTools.external.cornerstone = cornerstone;
                    cornerstoneTools.external.$ = window.jQuery || {};
                    cornerstoneTools.external.Hammer = Hammer;
                    cornerstoneTools.init();
                    
                    // Add medical imaging tools
                    cornerstoneTools.addTool(cornerstoneTools.WwwcTool);
                    cornerstoneTools.addTool(cornerstoneTools.ZoomTool);
                    cornerstoneTools.addTool(cornerstoneTools.PanTool);
                    cornerstoneTools.addTool(cornerstoneTools.LengthTool);
                    cornerstoneTools.addTool(cornerstoneTools.AngleTool);
                    cornerstoneTools.addTool(cornerstoneTools.RectangleRoiTool);
                }

                // Enable all viewports
                viewports.axial = document.getElementById('axialCanvas');
                viewports.sagittal = document.getElementById('sagittalCanvas');
                viewports.coronal = document.getElementById('coronalCanvas');
                viewports.volume = document.getElementById('volumeCanvas');

                Object.values(viewports).forEach(viewport => {
                    if (viewport) {
                        cornerstone.enable(viewport);
                        
                        // Set default tool
                        if (typeof cornerstoneTools !== 'undefined') {
                            cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 }, viewport);
                        }
                        
                        // Add crosshair sync events
                        viewport.addEventListener('cornerstonenewimage', updateCrosshairs);
                        viewport.addEventListener('cornerstoneimagerendered', updateViewportInfo);
                    }
                });

                // Load sample medical volume
                loadSampleMedicalVolume();
                
                // Setup tool button handlers
                setupToolHandlers();
                
                // Setup control handlers
                setupControlHandlers();
                
                // Setup viewport click handlers
                setupViewportHandlers();

            } catch(error) {
                console.error('MPR Viewer initialization error:', error);
                showMedicalAlert('MPR Viewer initialized - Ready for DICOM files', 'info');
            }
        });

        function setupToolHandlers() {
            // Medical imaging tool handlers
            document.getElementById('wwwcTool').onclick = () => setMedicalTool('Wwwc', 'wwwcTool');
            document.getElementById('zoomTool').onclick = () => setMedicalTool('Zoom', 'zoomTool');
            document.getElementById('panTool').onclick = () => setMedicalTool('Pan', 'panTool');
            document.getElementById('lengthTool').onclick = () => setMedicalTool('Length', 'lengthTool');
            document.getElementById('angleTool').onclick = () => setMedicalTool('Angle', 'angleTool');
            document.getElementById('roiTool').onclick = () => setMedicalTool('RectangleRoi', 'roiTool');
            
            document.getElementById('resetTool').onclick = resetAllViewports;
            document.getElementById('invertTool').onclick = invertAllViewports;
            document.getElementById('syncTool').onclick = toggleCrosshairSync;
        }

        function setupControlHandlers() {
            // Window/Level controls
            document.getElementById('windowWidth').oninput = function() {
                const value = this.value;
                document.getElementById('windowWidthValue').textContent = value;
                updateWindowLevel();
            };
            
            document.getElementById('windowLevel').oninput = function() {
                const value = this.value;
                document.getElementById('windowLevelValue').textContent = value;
                updateWindowLevel();
            };
            
            document.getElementById('slicePosition').oninput = function() {
                const value = this.value;
                document.getElementById('slicePositionValue').textContent = value + '/100';
                updateSlicePosition(value);
            };
        }

        function setupViewportHandlers() {
            // Click handlers for viewport activation
            Object.entries(viewports).forEach(([name, viewport]) => {
                if (viewport) {
                    viewport.parentElement.onclick = () => setActiveViewport(name);
                }
            });
        }

        function setMedicalTool(toolName, buttonId) {
            try {
                if (typeof cornerstoneTools !== 'undefined') {
                    // Deactivate all tools on all viewports
                    Object.values(viewports).forEach(viewport => {
                        if (viewport) {
                            cornerstoneTools.setToolPassive('Wwwc', viewport);
                            cornerstoneTools.setToolPassive('Zoom', viewport);
                            cornerstoneTools.setToolPassive('Pan', viewport);
                            cornerstoneTools.setToolPassive('Length', viewport);
                            cornerstoneTools.setToolPassive('Angle', viewport);
                            cornerstoneTools.setToolPassive('RectangleRoi', viewport);
                            
                            // Activate new tool
                            cornerstoneTools.setToolActive(toolName, { mouseButtonMask: 1 }, viewport);
                        }
                    });
                }

                // Update button states
                document.querySelectorAll('.medical-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(buttonId).classList.add('active');
                
                showMedicalAlert(`${toolName} tool activated`, 'success');
            } catch(error) {
                console.error('Tool activation error:', error);
            }
        }

        function setActiveViewport(viewportName) {
            // Remove active class from all viewports
            document.querySelectorAll('.mpr-viewport').forEach(vp => vp.classList.remove('active'));
            
            // Add active class to selected viewport
            document.getElementById(viewportName + 'Viewport').classList.add('active');
        }

        function loadSampleMedicalVolume() {
            // Create sample medical volume data for each view
            const views = ['axial', 'sagittal', 'coronal'];
            
            views.forEach((view, index) => {
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const ctx = canvas.getContext('2d');
                
                // Create different anatomical views
                createMedicalView(ctx, view, index);
                
                const imageId = canvas.toDataURL();
                const viewport = viewports[view];
                
                if (viewport) {
                    cornerstone.loadImage(imageId).then(function(image) {
                        cornerstone.displayImage(viewport, image);
                        updateViewportInfo();
                    }).catch(function(error) {
                        console.error(`Error loading ${view} view:`, error);
                    });
                }
            });
            
            // Load 3D volume view
            loadVolumeView();
        }

        function createMedicalView(ctx, view, index) {
            // Clear canvas
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 512, 512);
            
            // Create medical-looking anatomy based on view
            const gradient = ctx.createRadialGradient(256, 256, 50, 256, 256, 200);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(0.5, '#cccccc');
            gradient.addColorStop(1, '#333333');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 512, 512);
            
            // Add anatomical structures based on view
            switch(view) {
                case 'axial':
                    // Brain/head axial view
                    ctx.fillStyle = '#888888';
                    ctx.beginPath();
                    ctx.arc(256, 256, 150, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    ctx.fillStyle = '#444444';
                    ctx.beginPath();
                    ctx.arc(200, 200, 30, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(312, 200, 30, 0, 2 * Math.PI);
                    ctx.fill();
                    break;
                    
                case 'sagittal':
                    // Sagittal profile view
                    ctx.fillStyle = '#888888';
                    ctx.fillRect(150, 100, 200, 300);
                    ctx.fillStyle = '#666666';
                    ctx.fillRect(180, 120, 140, 50);
                    break;
                    
                case 'coronal':
                    // Coronal frontal view
                    ctx.fillStyle = '#888888';
                    ctx.beginPath();
                    ctx.ellipse(256, 200, 120, 80, 0, 0, 2 * Math.PI);
                    ctx.fill();
                    break;
            }
            
            // Add view label
            ctx.fillStyle = '#00d4ff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(view.toUpperCase() + ' VIEW', 256, 30);
            
            // Add medical markers
            ctx.fillStyle = '#00d4ff';
            ctx.font = '10px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('L', 20, 256);
            ctx.textAlign = 'right';
            ctx.fillText('R', 492, 256);
            ctx.textAlign = 'center';
            ctx.fillText('A', 256, 20);
            ctx.fillText('P', 256, 502);
        }

        function loadVolumeView() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Create 3D volume representation
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 512, 512);
            
            // Gradient for 3D effect
            const gradient = ctx.createLinearGradient(0, 0, 512, 512);
            gradient.addColorStop(0, '#666666');
            gradient.addColorStop(0.5, '#888888');
            gradient.addColorStop(1, '#aaaaaa');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(100, 100, 312, 312);
            
            // Add 3D structure representation
            ctx.fillStyle = '#cccccc';
            ctx.fillRect(150, 150, 212, 212);
            
            ctx.fillStyle = '#00d4ff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('3D VOLUME', 256, 50);
            ctx.font = '12px Arial';
            ctx.fillText('Ready for Reconstruction', 256, 450);
            
            const imageId = canvas.toDataURL();
            const viewport = viewports.volume;
            
            if (viewport) {
                cornerstone.loadImage(imageId).then(function(image) {
                    cornerstone.displayImage(viewport, image);
                }).catch(function(error) {
                    console.error('Error loading volume view:', error);
                });
            }
        }

        function updateWindowLevel() {
            const windowWidth = parseInt(document.getElementById('windowWidth').value);
            const windowLevel = parseInt(document.getElementById('windowLevel').value);
            
            Object.values(viewports).forEach(viewport => {
                if (viewport) {
                    try {
                        const currentViewport = cornerstone.getViewport(viewport);
                        if (currentViewport) {
                            currentViewport.voi.windowWidth = windowWidth;
                            currentViewport.voi.windowCenter = windowLevel;
                            cornerstone.setViewport(viewport, currentViewport);
                        }
                    } catch(error) {
                        console.error('Window/Level update error:', error);
                    }
                }
            });
            
            updateViewportInfo();
        }

        function updateSlicePosition(position) {
            // Update slice position for all MPR views
            showMedicalAlert(`Slice position: ${position}`, 'info');
        }

        function updateCrosshairs(event) {
            if (!crosshairSync) return;
            
            try {
                const viewport = event.target;
                const viewportRect = viewport.getBoundingClientRect();
                const centerX = viewportRect.width / 2;
                const centerY = viewportRect.height / 2;
                
                // Update crosshair positions for all viewports
                Object.keys(viewports).forEach(viewName => {
                    const crosshair = document.getElementById(viewName + 'Crosshair');
                    if (crosshair && viewports[viewName] !== viewport) {
                        const horizontal = crosshair.querySelector('.crosshair-horizontal');
                        const vertical = crosshair.querySelector('.crosshair-vertical');
                        
                        if (horizontal) horizontal.style.top = centerY + 'px';
                        if (vertical) vertical.style.left = centerX + 'px';
                    }
                });
            } catch(error) {
                console.error('Crosshair sync error:', error);
            }
        }

        function updateViewportInfo() {
            Object.entries(viewports).forEach(([viewName, viewport]) => {
                if (viewport) {
                    try {
                        const vp = cornerstone.getViewport(viewport);
                        const infoElement = document.getElementById(viewName + 'Info');
                        
                        if (vp && infoElement) {
                            infoElement.innerHTML = `
                                <div>Slice: 1/100</div>
                                <div>W: ${Math.round(vp.voi.windowWidth)} L: ${Math.round(vp.voi.windowCenter)}</div>
                                <div>Zoom: ${Math.round(vp.scale * 100)}%</div>
                            `;
                        }
                    } catch(error) {
                        console.error('Viewport info update error:', error);
                    }
                }
            });
        }

        function resetAllViewports() {
            Object.values(viewports).forEach(viewport => {
                if (viewport) {
                    cornerstone.reset(viewport);
                }
            });
            updateViewportInfo();
            showMedicalAlert('All viewports reset', 'success');
        }

        function invertAllViewports() {
            Object.values(viewports).forEach(viewport => {
                if (viewport) {
                    try {
                        const vp = cornerstone.getViewport(viewport);
                        if (vp) {
                            vp.invert = !vp.invert;
                            cornerstone.setViewport(viewport, vp);
                        }
                    } catch(error) {
                        console.error('Invert error:', error);
                    }
                }
            });
            showMedicalAlert('Image inversion toggled', 'success');
        }

        function toggleCrosshairSync() {
            crosshairSync = !crosshairSync;
            const btn = document.getElementById('syncTool');
            if (crosshairSync) {
                btn.classList.add('active');
                showMedicalAlert('Crosshair synchronization enabled', 'success');
            } else {
                btn.classList.remove('active');
                showMedicalAlert('Crosshair synchronization disabled', 'info');
            }
        }

        // 3D Reconstruction Functions
        function startBoneReconstruction() {
            const btn = event.target;
            btn.classList.add('processing');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            setTimeout(() => {
                btn.classList.remove('processing');
                btn.innerHTML = '<i class="fas fa-bone"></i> Bone 3D';
                showMedicalAlert('Bone 3D reconstruction completed', 'success');
                
                // Update volume viewport with bone rendering
                loadBoneVolume();
            }, 3000);
        }

        function startMRIReconstruction() {
            const btn = event.target;
            btn.classList.add('processing');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            setTimeout(() => {
                btn.classList.remove('processing');
                btn.innerHTML = '<i class="fas fa-brain"></i> MRI 3D';
                showMedicalAlert('MRI 3D reconstruction completed', 'success');
                loadMRIVolume();
            }, 2500);
        }

        function startMIPReconstruction() {
            showMedicalAlert('Maximum Intensity Projection started', 'info');
            setTimeout(() => {
                showMedicalAlert('MIP reconstruction completed', 'success');
            }, 2000);
        }

        function startVolumeRendering() {
            showMedicalAlert('Volume rendering started', 'info');
            setTimeout(() => {
                showMedicalAlert('Volume rendering completed', 'success');
                loadVolumeView();
            }, 1500);
        }

        function loadBoneVolume() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Create bone-like 3D structure
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 512, 512);
            
            // Bone gradient
            const gradient = ctx.createRadialGradient(256, 256, 50, 256, 256, 200);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(0.3, '#eeeeee');
            gradient.addColorStop(0.7, '#999999');
            gradient.addColorStop(1, '#333333');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(256, 256, 180, 0, 2 * Math.PI);
            ctx.fill();
            
            // Bone structure details
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(200, 150, 112, 200);
            ctx.fillRect(180, 200, 152, 100);
            
            ctx.fillStyle = '#00d4ff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('BONE 3D RECONSTRUCTION', 256, 50);
            
            const imageId = canvas.toDataURL();
            cornerstone.loadImage(imageId).then(function(image) {
                cornerstone.displayImage(viewports.volume, image);
            });
        }

        function loadMRIVolume() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Create MRI-like soft tissue structure
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 512, 512);
            
            // Soft tissue gradient
            const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 220);
            gradient.addColorStop(0, '#cccccc');
            gradient.addColorStop(0.4, '#888888');
            gradient.addColorStop(0.8, '#444444');
            gradient.addColorStop(1, '#111111');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(256, 256, 200, 0, 2 * Math.PI);
            ctx.fill();
            
            // Brain-like structures
            ctx.fillStyle = '#999999';
            ctx.beginPath();
            ctx.arc(220, 220, 40, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(292, 220, 40, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = '#00d4ff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('MRI 3D RECONSTRUCTION', 256, 50);
            
            const imageId = canvas.toDataURL();
            cornerstone.loadImage(imageId).then(function(image) {
                cornerstone.displayImage(viewports.volume, image);
            });
        }

        function showMedicalAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-left: 4px solid var(--accent-color);
                color: var(--text-primary);
                padding: 10px 15px;
                border-radius: 4px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                z-index: 10000;
                font-size: 11px;
                max-width: 300px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            if (type === 'success') {
                alert.style.borderLeftColor = 'var(--success-color)';
            } else if (type === 'error') {
                alert.style.borderLeftColor = 'var(--danger-color)';
            }
            
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '1';
                alert.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(alert);
                }, 300);
            }, 3000);
        }

        // Initialize crosshair positions
        setTimeout(() => {
            Object.keys(viewports).forEach(viewName => {
                const crosshair = document.getElementById(viewName + 'Crosshair');
                if (crosshair) {
                    crosshair.style.display = crosshairSync ? 'block' : 'none';
                }
            });
        }, 1000);
    </script>
</body>
</html>