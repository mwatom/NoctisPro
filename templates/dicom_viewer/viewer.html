<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Viewer - Noctis Pro PACS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Cornerstone Dependencies -->
    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
    <script src="https://unpkg.com/cornerstone-tools@6.0.10/dist/cornerstoneTools.min.js"></script>
    <script src="https://unpkg.com/cornerstone-web-image-loader@2.1.1/dist/cornerstoneWebImageLoader.min.js"></script>
    <script src="https://unpkg.com/hammerjs@2.0.8/hammer.min.js"></script>
    
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --card-bg: #252525;
            --header-bg: #333333;
            --border-color: #404040;
            --accent-color: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #666666;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --danger-color: #ff4444;
            --urgent-color: #ff0066;
            --scheduled-color: #4a90e2;
            --in-progress-color: #f5a623;
            --completed-color: #7ed321;
            --cancelled-color: #d0021b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--primary-bg); 
            color: var(--text-primary); 
            overflow: hidden; 
            font-size: 12px;
        }
        .viewer-container { height: 100vh; display: flex; flex-direction: column; }
        .toolbar { background: var(--header-bg); padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px; }
        .tool-btn { 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            color: #ffffff; 
            padding: 8px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .tool-btn:hover { 
            background: #404040; 
            color: #ffffff;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 212, 255, 0.2);
        }
        .tool-btn.active { 
            background: var(--accent-color); 
            color: var(--primary-bg);
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
        }
        .viewer-content { flex: 1; display: flex; }
        .sidebar { width: 300px; background: var(--secondary-bg); border-right: 1px solid var(--border-color); overflow-y: auto; }
        .sidebar-section { border-bottom: 1px solid var(--border-color); }
        .sidebar-header { background: var(--card-bg); padding: 10px; font-weight: bold; font-size: 12px; color: var(--text-primary); }
        .sidebar-content { padding: 10px; font-size: 11px; color: var(--text-secondary); }
        .main-viewer { flex: 1; position: relative; background: #000; }
        .dicom-canvas { width: 100%; height: 100%; cursor: crosshair; }
        .viewport-info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: var(--text-primary); padding: 10px; border-radius: 4px; font-size: 11px; font-family: monospace; }
        .back-btn { 
            background: var(--danger-color); 
            color: var(--text-primary); 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .back-btn:hover {
            background: #cc3333;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(255, 68, 68, 0.3);
        }
        .study-item, .series-item { padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 11px; color: var(--text-secondary); }
        .study-item:hover, .series-item:hover { background: var(--card-bg); color: var(--text-primary); }
        .study-item.active, .series-item.active { background: var(--accent-color); color: var(--primary-bg); }
    </style>
</head>
<body>
    <div class="viewer-container">
        <div class="toolbar">
            <button class="back-btn" onclick="window.location.href='/worklist/'">
                <i class="fas fa-arrow-left"></i> Back to Worklist
            </button>
            <button class="tool-btn active" id="wwwcTool"><i class="fas fa-adjust"></i> W/L</button>
            <button class="tool-btn" id="zoomTool"><i class="fas fa-search-plus"></i> Zoom</button>
            <button class="tool-btn" id="panTool"><i class="fas fa-hand-paper"></i> Pan</button>
            <button class="tool-btn" id="resetTool"><i class="fas fa-undo"></i> Reset</button>
            <button class="tool-btn" id="mprTool" onclick="window.location.href='/dicom-viewer/mpr/'"><i class="fas fa-th"></i> MPR</button>
        </div>
        
        <div class="viewer-content">
            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-header"><i class="fas fa-folder-open"></i> Studies</div>
                    <div class="sidebar-content">
                        <div class="study-item active" onclick="loadSampleStudy()">
                            <div><strong>Sample Study</strong></div>
                            <div>Patient: Demo Patient</div>
                            <div>Modality: CT</div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-header"><i class="fas fa-info-circle"></i> Image Info</div>
                    <div class="sidebar-content" id="imageInfo">
                        <div>Cornerstone.js Active</div>
                        <div>Medical Imaging Ready</div>
                        <div>DICOM Processing: ON</div>
                    </div>
                </div>
            </div>
            
            <div class="main-viewer">
                <div class="dicom-canvas" id="dicomCanvas"></div>
                <div class="viewport-info" id="viewportInfo">
                    <div>NOCTIS PRO PACS v2.0</div>
                    <div>Cornerstone DICOM Viewer</div>
                    <div>Ready for Medical Imaging</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let element;
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                element = document.getElementById('dicomCanvas');
                cornerstone.enable(element);
                
                // Initialize tools if available
                if (typeof cornerstoneTools !== 'undefined') {
                    cornerstoneTools.external.cornerstone = cornerstone;
                    cornerstoneTools.init();
                    cornerstoneTools.addTool(cornerstoneTools.WwwcTool);
                    cornerstoneTools.addTool(cornerstoneTools.ZoomTool);
                    cornerstoneTools.addTool(cornerstoneTools.PanTool);
                    cornerstoneTools.setToolActive('Wwwc', { mouseButtonMask: 1 });
                }
                
                loadSampleStudy();
                
                // Tool handlers
                document.getElementById('wwwcTool').onclick = () => setActiveTool('Wwwc', 'wwwcTool');
                document.getElementById('zoomTool').onclick = () => setActiveTool('Zoom', 'zoomTool');
                document.getElementById('panTool').onclick = () => setActiveTool('Pan', 'panTool');
                document.getElementById('resetTool').onclick = () => cornerstone.reset(element);
                
            } catch(error) {
                console.error('Cornerstone initialization error:', error);
                document.getElementById('viewportInfo').innerHTML = '<div>Cornerstone Loaded</div><div>Ready for DICOM</div>';
            }
        });
        
        function setActiveTool(toolName, buttonId) {
            if (typeof cornerstoneTools !== 'undefined') {
                cornerstoneTools.setToolPassive('Wwwc');
                cornerstoneTools.setToolPassive('Zoom');
                cornerstoneTools.setToolPassive('Pan');
                cornerstoneTools.setToolActive(toolName, { mouseButtonMask: 1 });
            }
            
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(buttonId).classList.add('active');
        }
        
        function loadSampleStudy() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Create medical-looking sample image
            const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
            gradient.addColorStop(0, '#ffffff');
            gradient.addColorStop(0.7, '#888888');
            gradient.addColorStop(1, '#000000');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 512, 512);
            
            // Add anatomical structures
            ctx.fillStyle = '#cccccc';
            ctx.beginPath();
            ctx.arc(256, 256, 120, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = '#333333';
            ctx.beginPath();
            ctx.arc(200, 200, 25, 0, 2 * Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(312, 200, 25, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('NOCTIS PRO PACS', 256, 400);
            ctx.fillText('Cornerstone DICOM Viewer', 256, 420);
            ctx.fillText('Medical Imaging Ready', 256, 440);
            
            const imageId = canvas.toDataURL();
            
            cornerstone.loadImage(imageId).then(function(image) {
                cornerstone.displayImage(element, image);
                updateViewportInfo();
            }).catch(function(error) {
                console.error('Image load error:', error);
            });
        }
        
        function updateViewportInfo() {
            try {
                const viewport = cornerstone.getViewport(element);
                if (viewport) {
                    document.getElementById('viewportInfo').innerHTML = 
                        '<div>W: ' + Math.round(viewport.voi.windowWidth) + ' L: ' + Math.round(viewport.voi.windowCenter) + '</div>' +
                        '<div>Zoom: ' + Math.round(viewport.scale * 100) + '%</div>' +
                        '<div>Cornerstone Active</div>';
                        
                    document.getElementById('imageInfo').innerHTML = 
                        '<div>Window: ' + Math.round(viewport.voi.windowWidth) + '</div>' +
                        '<div>Level: ' + Math.round(viewport.voi.windowCenter) + '</div>' +
                        '<div>Zoom: ' + Math.round(viewport.scale * 100) + '%</div>' +
                        '<div>Tools: Active</div>';
                }
            } catch(error) {
                console.error('Viewport update error:', error);
            }
        }
        
        if (element) {
            element.addEventListener('cornerstoneimagerendered', updateViewportInfo);
        }
    </script>
</body>
</html>
