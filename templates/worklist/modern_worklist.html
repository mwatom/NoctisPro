{% extends 'base.html' %}

{% block title %}Noctis Pro PACS - Worklist{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-bg: var(--primary-bg);
        --secondary-bg: var(--secondary-bg);
        --card-bg: var(--card-bg);
        --header-bg: var(--header-bg);
        --border-color: var(--border-color);
        --accent-color: var(--accent-color);
        --text-primary: var(--text-primary);
        --text-secondary: var(--text-secondary);
        --text-muted: var(--text-muted);
        --success-color: var(--success-color);
        --warning-color: var(--warning-color);
        --danger-color: var(--danger-color);
        --urgent-color: #ff0066;
        --scheduled-color: #4a90e2;
        --in-progress-color: #f5a623;
        --completed-color: #7ed321;
        --cancelled-color: #d0021b;
        --suspended-color: #ff5a5f;
    }

    body { background: var(--primary-bg); color: var(--text-primary); font-size: 12px; overflow: hidden; }
    .dashboard-container { height: 100vh; display: flex; flex-direction: column; }

    /* Top Navigation */
    .top-navbar { background: var(--header-bg); border-bottom: 1px solid var(--border-color); padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; height: 50px; }
    .nav-left { display: flex; align-items: center; gap: 20px; }
    .logo { color: var(--accent-color); font-weight: bold; font-size: 16px; }
    .nav-tabs { display: flex; gap: 2px; }
    .nav-tab { background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 12px; font-size: 11px; cursor: pointer; }
    .nav-tab.active { background: var(--accent-color); color: var(--primary-bg); font-weight: bold; }
    .nav-tab:hover:not(.active) { background: var(--card-bg); color: var(--text-primary); }
    .nav-right { display: flex; align-items: center; gap: 15px; font-size: 11px; }
    .user-info { display: flex; align-items: center; gap: 8px; }
    .user-avatar { background: var(--accent-color); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--primary-bg); font-size: 10px; }
    .status-indicator { display: flex; align-items: center; gap: 4px; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success-color); }

    /* Controls Bar */
    .controls-bar { background: var(--secondary-bg); border-bottom: 1px solid var(--border-color); padding: 8px 16px; display: flex; align-items: center; gap: 12px; height: 40px; flex-wrap: wrap; }
    .control-group { display: flex; align-items: center; gap: 6px; }
    .control-label { font-size: 11px; color: var(--text-secondary); font-weight: 500; }
    .control-input, .control-select { background: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px 8px; font-size: 11px; border-radius: 2px; min-width: 120px; }
    .control-input:focus, .control-select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
    .btn-control { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px 12px; font-size: 11px; cursor: pointer; border-radius: 2px; }
    .btn-control:hover { background: var(--accent-color); color: var(--primary-bg); }
    .btn-control.reset { background: var(--accent-color); color: var(--primary-bg); }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* Data Table */
    .data-table-container { flex: 1; overflow: auto; background: var(--primary-bg); }
    .data-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 11px; }
    .data-table th { background: var(--header-bg); color: var(--text-primary); padding: 8px 12px; text-align: left; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); border-right: 1px solid var(--border-color); position: sticky; top: 0; z-index: 10; white-space: nowrap; }
    .data-table th:last-child { border-right: none; }
    .data-table td { padding: 4px 12px; border-bottom: 1px solid rgba(64, 64, 64, 0.3); border-right: 1px solid rgba(64, 64, 64, 0.3); color: var(--text-secondary); white-space: nowrap; vertical-align: middle; font-size: 11px; }
    .data-table td:last-child { border-right: none; }
    .data-table tbody tr { transition: background-color 0.1s ease; cursor: pointer; }
    .data-table tbody tr:hover { background: rgba(0, 212, 255, 0.08); }
    .data-table tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.02); }
    .data-table tbody tr:nth-child(even):hover { background: rgba(0, 212, 255, 0.08); }

    /* Data Styling */
    .patient-id, .study-id, .accession { font-family: 'Courier New', monospace; font-weight: bold; color: var(--accent-color); }
    .patient-name { font-weight: 600; color: var(--text-primary); }
    .timestamp { font-family: 'Courier New', monospace; color: var(--text-muted); font-size: 10px; }
    .study-count { background: var(--accent-color); color: var(--primary-bg); padding: 2px 6px; border-radius: 10px; font-size: 9px; font-weight: bold; display: inline-block; min-width: 20px; text-align: center; }

    /* Status Badges */
    .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 9px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; display: inline-flex; align-items: center; gap: 4px; }
    .status-scheduled { background: rgba(74, 144, 226, 0.2); color: var(--scheduled-color); border: 1px solid var(--scheduled-color); }
    .status-urgent { background: rgba(255, 0, 102, 0.2); color: var(--urgent-color); border: 1px solid var(--urgent-color); animation: pulse 2s infinite; }
    .status-in-progress, .status-in_progress { background: rgba(245, 166, 35, 0.2); color: var(--in-progress-color); border: 1px solid var(--in-progress-color); }
    .status-completed { background: rgba(126, 211, 33, 0.2); color: var(--completed-color); border: 1px solid var(--completed-color); }
    .status-cancelled { background: rgba(208, 2, 27, 0.2); color: var(--cancelled-color); border: 1px solid var(--cancelled-color); }
    .status-suspended { background: rgba(255, 90, 95, 0.2); color: var(--suspended-color); border: 1px solid var(--suspended-color); }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    /* Modality Badges */
    .modality-badge { background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; }
    .modality-ct { border-color: #4a90e2; color: #4a90e2; }
    .modality-mr, .modality-mri { border-color: #7b68ee; color: #7b68ee; }
    .modality-xr { border-color: #50c878; color: #50c878; }
    .modality-us { border-color: #ffa500; color: #ffa500; }
    .modality-nm { border-color: #ff6347; color: #ff6347; }

    /* Footer Status Bar */
    .footer-status { background: var(--secondary-bg); border-top: 1px solid var(--border-color); padding: 6px 16px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: var(--text-muted); height: 30px; }
    .status-left { display: flex; gap: 20px; }
    .status-right { display: flex; gap: 15px; align-items: center; }
    .connection-status { display: flex; align-items: center; gap: 4px; }
    .connection-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success-color); }

    /* DICOM Viewer Buttons */
    .viewer-buttons { display: flex; gap: 4px; align-items: center; }
    .btn-viewer { background: var(--accent-color); border: none; color: var(--primary-bg); padding: 4px 8px; border-radius: 3px; font-size: 9px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; }
    .btn-viewer:hover { background: #00b8d4; transform: scale(1.05); }
    .btn-viewer.viewer-only { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-viewer.viewer-only:hover { background: var(--text-secondary); color: var(--primary-bg); }

    .upload-area { text-align: center; padding: 60px 20px; background: var(--secondary-bg); border: 2px dashed var(--border-color); border-radius: 8px; margin: 20px; }
    .upload-area i { font-size: 48px; color: var(--text-muted); margin-bottom: 16px; display: block; }
    .upload-title { color: var(--text-primary); font-size: 18px; font-weight: bold; margin-bottom: 8px; }
    .upload-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; }
    .btn-upload { background: var(--accent-color); color: var(--primary-bg); border: none; padding: 12px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }

    @media (max-width: 1200px) {
        .data-table th, .data-table td { padding: 4px 8px; font-size: 10px; }
        .controls-bar { flex-wrap: wrap; height: auto; min-height: 40px; }
        .viewer-buttons { flex-direction: column; gap: 2px; }
        .btn-viewer { font-size: 8px; padding: 3px 6px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <nav class="top-navbar">
        <div class="nav-left">
            <div class="logo"><i class="fas fa-hospital-symbol"></i> Noctis Pro PACS</div>
            <div class="nav-tabs">
                <div class="nav-tab active">WORKLIST</div>
                <div class="nav-tab" onclick="window.location.href='{% url 'worklist:study_list' %}'">STUDIES</div>
                <div class="nav-tab" onclick="window.location.href='{% url 'worklist:dashboard' %}'">PATIENTS</div>
                <div class="nav-tab" onclick="window.location.href='{% url 'reports:report_list' %}'">REPORTS</div>
            </div>
        </div>
        <div class="nav-right">
            <div class="status-indicator"><div class="status-dot"></div><span>ONLINE</span></div>
            <div class="user-info">
                <div class="user-avatar">{% if user.first_name %}{{ user.first_name|first|upper }}{{ user.last_name|first|upper }}{% else %}U{% endif %}</div>
                <div>
                    <div>{{ user.get_full_name|default:user.username }}</div>
                    <div style="color: var(--text-muted); font-size: 10px;">{% if user.is_radiologist %}Radiologist{% else %}User{% endif %}</div>
                </div>
            </div>
        </div>
    </nav>

    <div class="controls-bar">
        <div class="control-group">
            <label class="control-label">Date:</label>
            <input type="date" class="control-input" id="dateFilter">
        </div>
        <div class="control-group">
            <label class="control-label">Status:</label>
            <select class="control-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="scheduled">Scheduled</option>
                <option value="urgent">Urgent</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
                <option value="suspended">Suspended</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Modality:</label>
            <select class="control-select" id="modalityFilter">
                <option value="">All Modalities</option>
                <option value="CT">CT</option>
                <option value="MR">MRI</option>
                <option value="XR">X-Ray</option>
                <option value="US">Ultrasound</option>
                <option value="NM">Nuclear Medicine</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Priority:</label>
            <select class="control-select" id="priorityFilter">
                <option value="">All Priorities</option>
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="normal">Normal</option>
                <option value="low">Low</option>
            </select>
        </div>
        <button class="btn-control reset" onclick="resetFilters()">RESET</button>
        <button class="btn-control" onclick="refreshData(this)"><i class="fas fa-sync-alt"></i> REFRESH</button>
        <button class="btn-control" onclick="launchDicomViewer()"><i class="fas fa-external-link-alt"></i> DICOM VIEWER</button>
        <button class="btn-control" onclick="uploadStudies()"><i class="fas fa-upload"></i> UPLOAD</button>
    </div>

    <div class="main-content">
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>TIME</th>
                        <th>PATIENT ID</th>
                        <th>NAME</th>
                        <th>ACCESSION</th>
                        <th>MODALITY</th>
                        <th>STATUS</th>
                        <th>PRIORITY</th>
                        <th>SCHEDULED</th>
                        <th>DURATION</th>
                        <th>TECHNOLOGIST</th>
                        <th>ROOM</th>
                        <th>DICOM VIEWER</th>
                    </tr>
                </thead>
                <tbody id="studiesTableBody">
                    <tr id="noDataRow">
                        <td colspan="12" style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-folder-open" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <div style="font-size: 14px; margin-bottom: 8px;">No studies found</div>
                            <div style="font-size: 12px;">Upload DICOM studies or check your filter settings</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="footer-status">
        <div class="status-left">
            <span>Total Studies: <strong id="countTotal">0</strong></span>
            <span>Urgent: <strong id="countUrgent" style="color: var(--urgent-color);">0</strong></span>
            <span>In Progress: <strong id="countInProgress" style="color: var(--in-progress-color);">0</strong></span>
            <span>Completed: <strong id="countCompleted" style="color: var(--completed-color);">0</strong></span>
        </div>
        <div class="status-right">
            <div class="connection-status"><div class="connection-dot"></div><span>DICOM Server Connected</span></div>
            <span>Last Update: <strong id="lastUpdate">--:--</strong></span>
            <span>Auto-refresh: <strong>ON</strong></span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let studiesData = [];
let filteredData = [];

async function loadStudiesData() {
    try {
        const response = await fetch('{% url "worklist:api_studies" %}');
        const data = await response.json();
        if (!data.success) throw new Error('Failed to load studies');
        studiesData = data.studies || [];
        filteredData = [...studiesData];
        renderStudiesTable();
        updateStatusCounts();
    } catch (err) {
        console.error('Error loading studies data:', err);
        showNoDataMessage();
    }
}

function renderStudiesTable() {
    const tbody = document.getElementById('studiesTableBody');
    const noDataRow = document.getElementById('noDataRow');
    if (!filteredData.length) {
        tbody.innerHTML = '';
        if (noDataRow) tbody.appendChild(noDataRow);
        return;
    }
    if (noDataRow) noDataRow.remove();
    tbody.innerHTML = filteredData.map(study => {
        const modalityClass = `modality-${(study.modality || '').toLowerCase()}`;
        const statusClass = `status-${(study.status || '').replace('_','-')}`;
        return `
            <tr onclick="selectStudy(this)" data-study-id="${study.id}">
                <td class="timestamp">${formatTime(study.study_time || study.study_date)}</td>
                <td class="patient-id">${escapeHtml(study.patient_id || '')}</td>
                <td class="patient-name">${escapeHtml(study.patient_name || '')}</td>
                <td class="accession">${escapeHtml(study.accession_number || '')}</td>
                <td><span class="modality-badge ${modalityClass}">${escapeHtml(study.modality || '')}</span></td>
                <td><span class="status-badge ${statusClass}">${getStatusIcon(study.status)} ${formatStatus(study.status)}</span></td>
                <td class="priority">${(study.priority || '').toUpperCase()}</td>
                <td class="timestamp">-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>
                    <div class="viewer-buttons">
                        <button class="btn-viewer" onclick="openStudyInViewer(${study.id}); event.stopPropagation();"><i class="fas fa-eye"></i> VIEW</button>
                    </div>
                </td>
            </tr>`;
    }).join('');
}

function formatTime(timeString) {
    if (!timeString) return '-';
    const date = new Date(timeString);
    return date.toLocaleTimeString('en-US', { hour12: false, timeStyle: 'short' });
}

function formatStatus(status) {
    if (!status) return '';
    return status.replace('_','-').toUpperCase();
}

function getStatusIcon(status) {
    const map = {
        'urgent': '<i class="fas fa-exclamation-triangle"></i>',
        'scheduled': '<i class="fas fa-clock"></i>',
        'in_progress': '<i class="fas fa-play"></i>',
        'in-progress': '<i class="fas fa-play"></i>',
        'completed': '<i class="fas fa-check"></i>',
        'cancelled': '<i class="fas fa-times"></i>',
        'suspended': '<i class="fas fa-ban"></i>'
    };
    return map[status] || '<i class="fas fa-circle"></i>';
}

function updateStatusCounts() {
    const counts = studiesData.reduce((acc, s) => {
        acc.total++;
        acc[s.status] = (acc[s.status] || 0) + 1;
        return acc;
    }, { total: 0 });
    document.getElementById('countTotal').textContent = counts.total || 0;
    document.getElementById('countUrgent').textContent = counts['urgent'] || 0;
    document.getElementById('countInProgress').textContent = (counts['in_progress'] || counts['in-progress'] || 0);
    document.getElementById('countCompleted').textContent = counts['completed'] || 0;
}

function showNoDataMessage() {
    const tbody = document.getElementById('studiesTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="12" class="upload-area">
                <i class="fas fa-folder-open"></i>
                <div class="upload-title">No DICOM Studies Found</div>
                <div class="upload-subtitle">Upload DICOM folders to populate the worklist</div>
                <button class="btn-upload" onclick="uploadStudies()"><i class="fas fa-upload"></i> Upload DICOM Studies</button>
            </td>
        </tr>`;
}

async function openStudyInViewer(studyId) {
    try {
        const res = await fetch(`/viewer/launch-desktop/${studyId}/`);
        const data = await res.json();
        if (data.success) {
            showToast('Launching desktop DICOM viewer...', 'success');
        } else {
            showToast(data.message || 'Failed to launch viewer', 'error');
        }
    } catch (e) {
        showToast('Error launching viewer', 'error');
    }
}

async function launchDicomViewer() {
    try {
        const res = await fetch('/viewer/launch-desktop/');
        const data = await res.json();
        if (data.success) showToast('Launching desktop DICOM viewer...', 'success');
        else showToast(data.message || 'Failed to launch viewer', 'error');
    } catch { showToast('Error launching viewer', 'error'); }
}

function uploadStudies() { window.location.href = '{% url 'worklist:upload_study' %}'; }

function selectStudy(row) {
    document.querySelectorAll('.data-table tbody tr').forEach(r => r.style.background = '');
    row.style.background = 'rgba(0, 212, 255, 0.15)';
}

function resetFilters() {
    document.getElementById('dateFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('modalityFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    filteredData = [...studiesData];
    renderStudiesTable();
}

function refreshData(btn) {
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');
    btn.disabled = true;
    loadStudiesData().then(() => {
        icon.classList.remove('fa-spin');
        btn.disabled = false;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
        showToast('Worklist refreshed', 'success');
    }).catch(() => {
        icon.classList.remove('fa-spin');
        btn.disabled = false;
        showToast('Error refreshing data', 'error');
    });
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const modalityFilter = document.getElementById('modalityFilter').value.toLowerCase();
    const priorityFilter = document.getElementById('priorityFilter').value.toLowerCase();
    const dateFilter = document.getElementById('dateFilter').value;
    filteredData = studiesData.filter(study => {
        const matchesStatus = !statusFilter || (study.status || '').toLowerCase() === statusFilter;
        const matchesModality = !modalityFilter || (study.modality || '').toLowerCase() === modalityFilter;
        const matchesPriority = !priorityFilter || (study.priority || '').toLowerCase() === priorityFilter;
        let matchesDate = true;
        if (dateFilter) {
            const sd = new Date(study.study_date).toDateString();
            const fd = new Date(dateFilter).toDateString();
            matchesDate = sd === fd;
        }
        return matchesStatus && matchesModality && matchesPriority && matchesDate;
    });
    renderStudiesTable();
}

document.addEventListener('DOMContentLoaded', function() {
    loadStudiesData();
    setInterval(() => {
        loadStudiesData();
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('en-US', { hour12: false });
    }, 30000);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('modalityFilter').addEventListener('change', applyFilters);
    document.getElementById('priorityFilter').addEventListener('change', applyFilters);
    document.getElementById('dateFilter').addEventListener('change', applyFilters);
});

function showToast(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `position: fixed; top: 20px; right: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-left: 4px solid var(--accent-color); color: var(--text-primary); padding: 12px 16px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; font-size: 12px; max-width: 300px;`;
    if (type === 'error') notification.style.borderLeftColor = 'var(--danger-color)';
    else if (type === 'success') notification.style.borderLeftColor = 'var(--success-color)';
    notification.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:flex-start;"><span>${message}</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text-muted);cursor:pointer;margin-left:8px;"><i class=\"fas fa-times\"></i></button></div>`;
    document.body.appendChild(notification);
    setTimeout(() => { if (notification.parentNode) notification.remove(); }, 4000);
}

function escapeHtml(str) { return (str || '').replace(/[&<>"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }
</script>
{% endblock %}