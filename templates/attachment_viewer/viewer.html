{% extends 'base.html' %}

{% block title %}Attachment Viewer - Noctis Pro PACS{% endblock %}

{% block extra_css %}
<style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --card-surface: #252525;
            --header-bg: #333333;
            --border-color: #404040;
            --accent-color: #00d4ff;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-muted: #666666;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --danger-color: #ff4444;
        }

	.viewer-container { padding: 16px; }
	.card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; }
	.card-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display:flex; justify-content: space-between; align-items:center; }
	.card-body { padding: 16px; }
	.viewer-area { display:flex; justify-content:center; align-items:center; min-height: 60vh; background: var(--secondary-bg); border-radius: 8px; }
	.viewer-area img { max-width: 100%; height: auto; border-radius: 8px; }
	.pre { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; color: var(--text-secondary); }
</style>
{% endblock %}

{% block content %}
<div class="viewer-container">
	<div class="card">
		<div class="card-header">
			<div class="d-flex align-items-center gap-2">
				<i class="fas fa-paperclip text-accent"></i>
				<div class="fw-bold">{{ attachment.name }}</div>
			</div>
			<div class="d-flex gap-2">
				<a href="{% url 'worklist:study_detail' study.id %}" class="btn-mini"><i class="fas fa-arrow-left"></i> Back to Study</a>
				<a href="{% url 'worklist:view_attachment' attachment.id %}?action=download" class="btn-mini"><i class="fas fa-download"></i> Download</a>
			</div>
		</div>
		<div class="card-body">
			<div id="viewer" class="viewer-area">
				<span class="small-muted">Loading...</span>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(async function(){
	try{
		const res = await fetch('{% url "worklist:api_view_attachment" attachment.id %}');
		const data = await res.json();
		const container = document.getElementById('viewer');
		container.innerHTML = '';
		if (data.type === 'image' && data.image_data){
			const img = document.createElement('img');
			img.src = data.image_data;
			container.appendChild(img);
		} else if (data.type === 'pdf' && data.image_data){
			const img = document.createElement('img');
			img.src = data.image_data;
			container.appendChild(img);
		} else if (data.type === 'text' && data.content){
			const pre = document.createElement('pre');
			pre.className = 'pre';
			pre.textContent = data.content;
			container.appendChild(pre);
		} else if (data.type === 'dicom_redirect' && data.redirect_url){
			window.location.href = data.redirect_url;
		} else if (data.type === 'study_redirect' && data.redirect_url){
			window.location.href = data.redirect_url;
		} else if (data.download_url){
			const a = document.createElement('a');
			a.href = data.download_url;
			a.textContent = 'Download attachment';
			container.appendChild(a);
		} else {
			container.innerHTML = '<span class="small-muted">Unable to preview this file. Use Download.</span>';
		}
	}catch(e){
		const container = document.getElementById('viewer');
		container.innerHTML = '<span class="small-muted">Error loading attachment.</span>';
	}
})();
</script>
{% endblock %}